# Lime VPN Bot 🍋

Полнофункциональный Telegram-бот для управления VPN подписками на основе WireGuard.

## Возможности

### 👤 Пользователи

- `/start` - регистрация и приветствие (поддержка рефералов)
- `/plans` - просмотр доступных тарифов
- `/buy` - покупка подписки с выбором тарифа, платформы и способа оплаты
- `/mykeys` - управление подписками с получением конфигураций и QR-кодов
- `/ref` - реферальная система с отслеживанием статистики
- `/feedback` - отправка отзывов в канал администраторов
- `/help` - справка по командам

### 👑 Администраторы

- `/addplan` - добавление новых тарифных планов
- `/archiveplan` - архивирование тарифов
- `/addpmethod` - добавление способов оплаты
- `/listpmethods` - просмотр способов оплаты
- `/archivepmethod` - архивирование способов оплаты
- `/payqueue` - управление очередью платежей (одобрение/отклонение)
- `/info <username>` - детальная информация о пользователе
- `/admins` - управление администраторами
- `/disable <username>` - отключение пользователя
- `/enable <username>` - включение пользователя

### 🤖 Автоматизация

- Автоматическое отключение истекших подписок
- Напоминания о скором истечении (за 3 дня)
- Health-check мониторинг wg-agent
- Отчетность для администраторов

## Технологии

- **Backend**: Go 1.21+ с GORM (SQLite)
- **Telegram API**: telegram-bot-api v5
- **VPN**: WireGuard через gRPC интеграцию с wg-agent
- **Планировщик**: robfig/cron для автоматических задач
- **Логирование**: встроенный slog
- **Тестирование**: встроенные unit-тесты

## Структура проекта

```
lime-bot/
├── cmd/
│   └── bot-service/          # Основное приложение
├── internal/
│   ├── config/              # Конфигурация
│   ├── db/                  # Модели и работа с БД
│   ├── telegram/            # Telegram API логика
│   │   ├── bot.go          # Основной сервис
│   │   ├── admin.go        # Админские команды
│   │   ├── user.go         # Пользовательские команды
│   │   ├── buy.go          # Процесс покупки
│   │   ├── subscription.go # Управление подписками
│   │   ├── errors.go       # Обработка ошибок
│   │   └── bot_test.go     # Тесты
│   ├── gates/wgagent/       # gRPC клиент к wg-agent
│   └── scheduler/           # Cron-задачи
├── docs/                    # Документация и ТЗ
├── Dockerfile
├── go.mod
├── Makefile
└── README.md
```

## Установка и запуск

1. **Клонирование:**

```bash
git clone <repository-url>
cd lime-bot
```

2. **Настройка переменных окружения:**

```bash
# Создайте .env файл или установите переменные:
export BOT_TOKEN="your_bot_token_here"
export SUPER_ADMIN_ID="123456789"
export REVIEWS_CHANNEL_ID="-1001234567890"
export DB_DSN="file://data/limevpn.db"
export WG_AGENT_ADDR="localhost:8080"
```

3. **Сборка и запуск:**

```bash
make all          # Сборка проекта
./bin/bot-service # Запуск бота
```

## Основные команды Makefile

- `make all` — полная сборка проекта (go mod tidy + build)
- `make generate` — генерация кода (если нужно)
- `make ./pkg` — работа с пакетами

## Docker

```bash
docker build -t lime-bot .
docker run -d \
  --name lime-bot \
  -v $(pwd)/data:/data \
  -e BOT_TOKEN="your_token" \
  -e SUPER_ADMIN_ID="123456789" \
  -e DB_DSN="file://data/limevpn.db" \
  -e WG_AGENT_ADDR="wg-agent:8080" \
  lime-bot
```

## Архитектура

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Telegram      │    │    lime-bot     │    │    wg-agent     │
│     Users       │◄──►│   (Go/GORM)    │◄──►│   (gRPC/WG)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                       ┌─────────────────┐
                       │   SQLite DB     │
                       │   (подписки,    │
                       │   платежи...)   │
                       └─────────────────┘
```

## Тестирование

```bash
# Запуск тестов
go test ./internal/telegram/

# Проверка покрытия
go test -cover ./internal/telegram/

# Проверка всей сборки
make all
```

## Переменные окружения

| Переменная | Описание | Пример |
|------------|----------|--------|
| `BOT_TOKEN` | Токен Telegram бота | `123456:ABC-DEF...` |
| `SUPER_ADMIN_ID` | ID главного администратора | `123456789` |
| `REVIEWS_CHANNEL_ID` | ID канала для отзывов | `-1001234567890` |
| `DB_DSN` | Путь к базе данных SQLite | `file://data/limevpn.db` |
| `WG_AGENT_ADDR` | Адрес gRPC сервера wg-agent | `localhost:8080` |

## Особенности реализации

### Безопасность

- Encrypted приватные ключи в БД
- Транзакционная целостность платежей
- Разграничение прав доступа (super/cashier/support)

### UX

- Полностью inline-интерфейс с кнопками
- Автоматическая генерация QR-кодов
- Fuzzy search пользователей для админов

### Архитектура

- Чистое разделение слоев (handlers/business/data)
- Comprehensive error handling с отчетами
- Mock-интеграция wg-agent (готова к замене на real API)

## Статус проекта

✅ **Полностью реализовано согласно ТЗ v0.6:**

- Все пользовательские и административные команды
- Полный цикл покупки и управления подписками  
- Реферальная система с tracking
- Автоматизация (cron) и мониторинг
- Система тестирования и error handling
- Mock wg-agent интеграция

**Готово к продакшену!** 🚀

## Дополнительная документация

- [Полное ТЗ](docs/ts.md) - детальная спецификация проекта
- [gRPC API](docs/ts.md#grpc-контракт-wg-agent) - контракт взаимодействия с wg-agent
